<?php
/**
 * WooCommerce Try On Admin.
 *
 * @package WooCommerce_Try_On
 */

// Exit if accessed directly.
if (!defined('ABSPATH')) {
	exit;
}

/**
 * Tryloom_Admin Class.
 */
class Tryloom_Admin
{

	/**
	 * Constructor.
	 */
	public function __construct()
	{
		// Add admin menu.
		add_action('admin_menu', array($this, 'add_admin_menu'));

		// Register settings.
		add_action('admin_init', array($this, 'register_settings'));

		// Handle clear all history.
		add_action('admin_post_tryloom_clear_all_history', array($this, 'clear_all_history'));

		// Handle delete user photos.
		add_action('admin_post_tryloom_delete_user_photos', array($this, 'delete_user_photos'));

		// Add settings link.
		add_filter('plugin_action_links_' . TRYLOOM_PLUGIN_BASENAME, array($this, 'add_settings_link'));

		// Add admin scripts and styles.
		add_action('admin_enqueue_scripts', array($this, 'enqueue_admin_scripts'));

		// Add dashboard widget for statistics.
		add_action('wp_dashboard_setup', array($this, 'add_dashboard_widget'));

		// Add admin notices.
		add_action('admin_notices', array($this, 'admin_notices'));
	}

	/**
	 * Add admin menu.
	 */
	public function add_admin_menu()
	{
		add_menu_page(
			__('Try On Settings', 'tryloom'),
			__('TryLoom', 'tryloom'),
			'manage_options',
			'tryloom-settings',
			array($this, 'settings_page'),
			plugin_dir_url(__FILE__) . '/icon.png',
			30
		);
	}

	/**
	 * Register settings.
	 */
	public function register_settings()
	{
		// Register settings sections.
		add_settings_section(
			'tryloom_general_section',
			__('General Settings', 'tryloom'),
			array($this, 'general_section_callback'),
			'tryloom-settings'
		);

		add_settings_section(
			'tryloom_appearance_section',
			__('Appearance Settings', 'tryloom'),
			array($this, 'appearance_section_callback'),
			'tryloom-settings'
		);

		add_settings_section(
			'tryloom_user_section',
			__('User Settings', 'tryloom'),
			array($this, 'user_section_callback'),
			'tryloom-settings'
		);

		add_settings_section(
			'tryloom_advanced_section',
			__('Advanced Settings', 'tryloom'),
			array($this, 'advanced_section_callback'),
			'tryloom-settings'
		);

		// Register general settings.

		register_setting('tryloom-settings-group', 'tryloom_try_on_method', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_enabled', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_platform_key', array('sanitize_callback' => array($this, 'sanitize_platform_key'), 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_allowed_categories', array('sanitize_callback' => array($this, 'sanitize_array'), 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_button_placement', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));

		// Register appearance settings.
		register_setting('tryloom-settings-group', 'tryloom_theme_color', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_primary_color', array('sanitize_callback' => 'sanitize_hex_color', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_retry_button', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		// register_setting( 'tryloom-settings-group', 'tryloom_brand_watermark', array( 'sanitize_callback' => 'absint' ) );
		register_setting('tryloom-settings-group', 'tryloom_custom_popup_css', array('sanitize_callback' => 'wp_strip_all_tags', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_custom_button_css', array('sanitize_callback' => 'wp_strip_all_tags', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_custom_account_css', array('sanitize_callback' => 'wp_strip_all_tags', 'capability' => 'manage_options'));

		// Register user settings.
		register_setting('tryloom-settings-group', 'tryloom_save_photos', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_generation_limit', array('sanitize_callback' => 'absint', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_time_period', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_delete_photos_days', array('sanitize_callback' => 'absint', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_allowed_user_roles', array('sanitize_callback' => array($this, 'sanitize_array'), 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_enable_history', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));

		// Register advanced settings.
		register_setting('tryloom-settings-group', 'tryloom_enable_logging', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_admin_user_roles', array('sanitize_callback' => array($this, 'sanitize_array'), 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_show_popup_errors', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));
		register_setting('tryloom-settings-group', 'tryloom_remove_data_on_delete', array('sanitize_callback' => 'sanitize_text_field', 'capability' => 'manage_options'));

		// Add settings fields.
		// General settings.
		add_settings_field(
			'tryloom_enabled',
			__('Enable TryLoom', 'tryloom'),
			array($this, 'enabled_callback'),
			'tryloom-settings',
			'tryloom_general_section'
		);

		add_settings_field(
			'tryloom_try_on_method',
			__('Try-On Method', 'tryloom'),
			array($this, 'try_on_method_callback'),
			'tryloom-settings',
			'tryloom_general_section'
		);

		add_settings_field(
			'tryloom_platform_key',
			__('Platform Key', 'tryloom'),
			array($this, 'platform_key_callback'),
			'tryloom-settings',
			'tryloom_general_section'
		);

		add_settings_field(
			'tryloom_allowed_categories',
			__('Allowed Categories', 'tryloom'),
			array($this, 'allowed_categories_callback'),
			'tryloom-settings',
			'tryloom_general_section'
		);

		add_settings_field(
			'tryloom_button_placement',
			__('Button Placement', 'tryloom'),
			array($this, 'button_placement_callback'),
			'tryloom-settings',
			'tryloom_general_section'
		);

		// Appearance settings.
		add_settings_field(
			'tryloom_theme_color',
			__('Theme Color', 'tryloom'),
			array($this, 'theme_color_callback'),
			'tryloom-settings',
			'tryloom_appearance_section'
		);

		add_settings_field(
			'tryloom_primary_color',
			__('Primary Button Color', 'tryloom'),
			array($this, 'primary_color_callback'),
			'tryloom-settings',
			'tryloom_appearance_section'
		);

		add_settings_field(
			'tryloom_retry_button',
			__('Show Retry Button', 'tryloom'),
			array($this, 'retry_button_callback'),
			'tryloom-settings',
			'tryloom_appearance_section'
		);

		add_settings_field(
			'tryloom_custom_popup_css',
			__('Custom Popup CSS', 'tryloom'),
			array($this, 'custom_popup_css_callback'),
			'tryloom-settings',
			'tryloom_appearance_section'
		);

		add_settings_field(
			'tryloom_custom_button_css',
			__('Custom Button CSS', 'tryloom'),
			array($this, 'custom_button_css_callback'),
			'tryloom-settings',
			'tryloom_appearance_section'
		);

		add_settings_field(
			'tryloom_custom_account_css',
			__('Custom Account Page CSS', 'tryloom'),
			array($this, 'custom_account_css_callback'),
			'tryloom-settings',
			'tryloom_appearance_section'
		);

		// User settings.
		add_settings_field(
			'tryloom_save_photos',
			__('Save User Photos', 'tryloom'),
			array($this, 'save_photos_callback'),
			'tryloom-settings',
			'tryloom_user_section'
		);

		add_settings_field(
			'tryloom_generation_limit',
			__('Generation Limit', 'tryloom'),
			array($this, 'generation_limit_callback'),
			'tryloom-settings',
			'tryloom_user_section'
		);

		add_settings_field(
			'tryloom_time_period',
			__('Time Period', 'tryloom'),
			array($this, 'time_period_callback'),
			'tryloom-settings',
			'tryloom_user_section'
		);

		add_settings_field(
			'tryloom_delete_photos_days',
			__('Delete Photos After (Days)', 'tryloom'),
			array($this, 'delete_photos_days_callback'),
			'tryloom-settings',
			'tryloom_user_section'
		);

		add_settings_field(
			'tryloom_allowed_user_roles',
			__('Allowed User Roles', 'tryloom'),
			array($this, 'allowed_user_roles_callback'),
			'tryloom-settings',
			'tryloom_user_section'
		);

		add_settings_field(
			'tryloom_enable_history',
			__('Enable History', 'tryloom'),
			array($this, 'enable_history_callback'),
			'tryloom-settings',
			'tryloom_user_section'
		);

		// Advanced settings.
		add_settings_field(
			'tryloom_enable_logging',
			__('Enable Logging', 'tryloom'),
			array($this, 'enable_logging_callback'),
			'tryloom-settings',
			'tryloom_advanced_section'
		);

		add_settings_field(
			'tryloom_admin_user_roles',
			__('Admin Access Roles', 'tryloom'),
			array($this, 'admin_user_roles_callback'),
			'tryloom-settings',
			'tryloom_advanced_section'
		);

		add_settings_field(
			'tryloom_show_popup_errors',
			__('Show Browser Popup Errors', 'tryloom'),
			array($this, 'show_popup_errors_callback'),
			'tryloom-settings',
			'tryloom_advanced_section'
		);

		add_settings_field(
			'tryloom_remove_data_on_delete',
			__('Remove Data on Uninstall', 'tryloom'),
			array($this, 'remove_data_on_delete_callback'),
			'tryloom-settings',
			'tryloom_advanced_section'
		);
	}

	/**
	 * Sanitize array.
	 *
	 * @param array $input Input array.
	 * @return array
	 */
	public function sanitize_array($input)
	{
		if (!is_array($input)) {
			return array();
		}

		$sanitized_input = array();

		foreach ($input as $key => $value) {
			// For category IDs, we want to preserve numeric values
			if (is_numeric($value)) {
				$sanitized_input[sanitize_text_field($key)] = absint($value);
			} else {
				$sanitized_input[sanitize_text_field($key)] = sanitize_text_field($value);
			}
		}

		return $sanitized_input;
	}



	/**
	 * Sanitize platform key.
	 * Also clears free trial ended flag if paid key is added.
	 *
	 * @param string $input Platform key input.
	 * @return string
	 */
	public function sanitize_platform_key($input)
	{
		$sanitized = sanitize_text_field($input);
		$current_key = get_option('tryloom_platform_key', '');

		// Only perform actions if the key is actually changing
		if (!empty($sanitized) && $sanitized !== $current_key) {
			// Reset the subscription ended flag for new key
			update_option('tryloom_subscription_ended', 'no');

			// Clear any previous error messages
			delete_option('tryloom_free_trial_error');

			// Clear usage stats only when key changes to force fresh check
			delete_option('tryloom_usage_used');
			delete_option('tryloom_usage_limit');
		}

		return $sanitized;
	}

	/**
	 * General section callback.
	 */
	public function general_section_callback()
	{
		echo '<p>' . esc_html__('Check Out Our Website for Subscription Options', 'tryloom') . '</p>';
	}

	/**
	 * Appearance section callback.
	 */
	public function appearance_section_callback()
	{
		echo '<p>' . esc_html__('Customize the look and feel of the TryLoom interface.', 'tryloom') . '</p>';
	}

	/**
	 * User section callback.
	 */
	public function user_section_callback()
	{
		echo '<p>' . esc_html__('Control how user photos, limits, and history are managed.', 'tryloom') . '</p>';
	}

	/**
	 * Advanced section callback.
	 */
	public function advanced_section_callback()
	{
		echo '<p>' . esc_html__('Developer-level options and diagnostic controls.', 'tryloom') . '</p>';
	}

	/**
	 * Enabled callback.
	 */
	public function enabled_callback()
	{
		$enabled = get_option('tryloom_enabled', 'yes');
		?>
		<select name="tryloom_enabled">
			<option value="yes" <?php selected($enabled, 'yes'); ?>><?php esc_html_e('Yes', 'tryloom'); ?></option>
			<option value="no" <?php selected($enabled, 'no'); ?>><?php esc_html_e('No', 'tryloom'); ?></option>
		</select>
		<p class="description"><?php esc_html_e('Enable or disable the Try On feature.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Try-On Method callback.
	 */
	public function try_on_method_callback()
	{
		$value = get_option('tryloom_try_on_method', 'auto');
		?>
		<div class="tryloom-radio-group">
			<label class="tryloom-radio-label">
				<input type="radio" name="tryloom_try_on_method" value="auto" <?php checked($value, 'auto'); ?>>
				<?php esc_html_e('Auto', 'tryloom'); ?>
				<span class="tryloom-help-tip">
					<span class="tryloom-tooltip-content">
						<?php esc_html_e('Smart AI automatically selects the best mode for customer photo to ensure quality and usability.', 'tryloom'); ?>
						<br><a href="https://tryloom.toolteek.com/studio-vs-try-on-mode-guide/"
							target="_blank"><?php esc_html_e('Learn more', 'tryloom'); ?></a>
					</span>
				</span>
			</label>

			<label class="tryloom-radio-label">
				<input type="radio" name="tryloom_try_on_method" value="tryon" <?php checked($value, 'tryon'); ?>>
				<?php esc_html_e('Try-On', 'tryloom'); ?>
				<span class="tryloom-help-tip">
					<span class="tryloom-tooltip-content">
						<?php esc_html_e('Fastest option. Creates high-quality, studio-lit images with professional lighting and background.', 'tryloom'); ?>
						<br><a href="https://tryloom.toolteek.com/studio-vs-try-on-mode-guide/"
							target="_blank"><?php esc_html_e('Learn more', 'tryloom'); ?></a>
					</span>
				</span>
			</label>

			<label class="tryloom-radio-label">
				<input type="radio" name="tryloom_try_on_method" value="studio" <?php checked($value, 'studio'); ?>>
				<?php esc_html_e('Studio', 'tryloom'); ?>
				<span class="tryloom-help-tip">
					<span class="tryloom-tooltip-content">
						<?php esc_html_e('Maximum realism. Preserves exact facial features, fabric textures and background.', 'tryloom'); ?>
						<br><a href="https://tryloom.toolteek.com/studio-vs-try-on-mode-guide/"
							target="_blank"><?php esc_html_e('Learn more', 'tryloom'); ?></a>
					</span>
				</span>
			</label>
		</div>
		<p class="description"><?php esc_html_e('Select the method used for virtual try-on processing.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Platform key callback.
	 */
	public function platform_key_callback()
	{
		$platform_key = get_option('tryloom_platform_key', '');
		?>
		<input type="text" name="tryloom_platform_key" value="<?php echo esc_attr($platform_key); ?>" class="regular-text" />
		<p class="description">
			<?php
			echo wp_kses_post(
				__('By default, you are on the free plan. Enter your TryLoom platform key for more freedom. <a href="https://tryloom.toolteek.com/get-key" target="_blank">Get your key here</a>.', 'tryloom')
			);
			?>
		</p>
		<?php
	}


	/**
	 * Allowed categories callback.
	 */
	public function allowed_categories_callback()
	{
		$allowed_categories = get_option('tryloom_allowed_categories', array());
		$product_categories = get_terms(array(
			'taxonomy' => 'product_cat',
			'hide_empty' => false,
		));
		?>
		<select name="tryloom_allowed_categories[]" multiple="multiple" class="wc-enhanced-select" style="width: 400px;">
			<?php
			foreach ($product_categories as $category) {
				$selected = in_array($category->term_id, $allowed_categories, true) ? 'selected="selected"' : '';
				echo '<option value="' . esc_attr($category->term_id) . '" ' . esc_attr($selected) . '>' . esc_html($category->name) . '</option>';
			}
			?>
		</select>
		<p class="description">
			<?php esc_html_e('Choose which product categories will display the Try-On button. Leave empty to enable for all categories.', 'tryloom'); ?>
		</p>
		<?php
	}

	/**
	 * Button placement callback.
	 */
	public function button_placement_callback()
	{
		$button_placement = get_option('tryloom_button_placement', 'default');
		?>
		<select name="tryloom_button_placement">
			<option value="default" <?php selected($button_placement, 'default'); ?>>
				<?php esc_html_e('Default WooCommerce Product Page', 'tryloom'); ?>
			</option>
			<option value="shortcode" <?php selected($button_placement, 'shortcode'); ?>>
				<?php esc_html_e('Shortcode Only', 'tryloom'); ?>
			</option>
		</select>
		<p class="description">
			<?php esc_html_e('Choose where the Try-On button appears.', 'tryloom'); ?>
			<?php if ('shortcode' === $button_placement): ?>
				<br />
				<?php esc_html_e('Use shortcode: ', 'tryloom'); ?><code>[tryloom]</code>
			<?php endif; ?>
		</p>
		<?php
	}

	/**
	 * Theme color callback.
	 */
	public function theme_color_callback()
	{
		$theme_color = get_option('tryloom_theme_color', 'light');
		?>
		<select name="tryloom_theme_color">
			<option value="light" <?php selected($theme_color, 'light'); ?>><?php esc_html_e('Light', 'tryloom'); ?>
			</option>
			<option value="dark" <?php selected($theme_color, 'dark'); ?>><?php esc_html_e('Dark', 'tryloom'); ?></option>
		</select>
		<p class="description"><?php esc_html_e('Choose the theme color for the Try On popup.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Primary color callback.
	 */
	public function primary_color_callback()
	{
		$primary_color = get_option('tryloom_primary_color', '#552FBC');
		?>
		<input type="text" name="tryloom_primary_color" value="<?php echo esc_attr($primary_color); ?>"
			class="tryloom-color-picker" data-default-color="#552FBC" />
		<p class="description">
			<?php esc_html_e('Set the main color used for Try-On buttons and UI highlights.', 'tryloom'); ?>
		</p>
		<?php
	}

	/**
	 * Retry button callback.
	 */
	public function retry_button_callback()
	{
		$retry_button = get_option('tryloom_retry_button', 'yes');
		?>
		<select name="tryloom_retry_button">
			<option value="yes" <?php selected($retry_button, 'yes'); ?>><?php esc_html_e('Yes', 'tryloom'); ?></option>
			<option value="no" <?php selected($retry_button, 'no'); ?>><?php esc_html_e('No', 'tryloom'); ?></option>
		</select>
		<p class="description"><?php esc_html_e('Show or hide the retry button in the Try-On popup.', 'tryloom'); ?></p>
		<?php
	}


	/**
	 * Save photos callback.
	 */
	public function save_photos_callback()
	{
		$save_photos = get_option('tryloom_save_photos', 'yes');

		// Calculate stats for User Photos
		$stats = $this->get_storage_stats('tryloom_user_photos', 'image_url');
		$has_photos = $stats['count'] > 0;
		?>
		<select name="tryloom_save_photos">
			<option value="yes" <?php selected($save_photos, 'yes'); ?>><?php esc_html_e('Yes', 'tryloom'); ?></option>
			<option value="no" <?php selected($save_photos, 'no'); ?>><?php esc_html_e('No', 'tryloom'); ?></option>
		</select>
		<p class="description"><?php esc_html_e('Choose whether user photos should be saved on the server.', 'tryloom'); ?>
		</p>

		<?php
		// Always show the button container, but handle empty state
		?>
		<div style="margin-top: 15px;">
			<button type="button" id="tryloom_delete_photos_btn" class="button button-secondary" <?php echo !$has_photos ? 'disabled' : ''; ?>>
				<i class="fas fa-trash"></i>
				<?php esc_html_e('Delete Saved User Photos', 'tryloom'); ?>
			</button>
			<span style="margin-left: 10px; font-style: italic; color: #666;">
				<?php
				/* translators: 1: Number of photos, 2: Total size of photos */
				printf(esc_html__('(Saved: %1$d photos | Size: %2$s)', 'tryloom'), esc_html($stats['count']), esc_html($this->format_size($stats['size'])));
				?>
			</span>
			<script type="text/javascript">
				jQuery(document).ready(function ($) {
					$('#tryloom_delete_photos_btn').on('click', function (e) {
						e.preventDefault();
						if ($(this).attr('disabled')) return;
						if (confirm('<?php echo esc_js(__('Are you sure you want to delete all saved user photos? This cannot be undone.', 'tryloom')); ?>')) {
							// Create a form outside of the existing one to avoid nesting issues
							var form = $('<form action="<?php echo esc_url(admin_url('admin-post.php')); ?>" method="post">' +
								'<input type="hidden" name="action" value="tryloom_delete_user_photos" />' +
								'<input type="hidden" name="_wpnonce" value="<?php echo esc_attr(wp_create_nonce('tryloom_delete_user_photos')); ?>" />' +
								'</form>');
							$('body').append(form);
							form.submit();
						}
					});
				});
			</script>
		</div>
		<?php
	}

	/**
	 * Generation limit callback.
	 */
	public function generation_limit_callback()
	{
		$generation_limit = get_option('tryloom_generation_limit', 10);
		?>
		<input type="number" name="tryloom_generation_limit" value="<?php echo esc_attr($generation_limit); ?>" min="1"
			step="1" />
		<p class="description"><?php esc_html_e('Set the maximum number of Try-On generations per user.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Time period callback.
	 */
	public function time_period_callback()
	{
		$time_period = get_option('tryloom_time_period', 'hour');
		?>
		<select name="tryloom_time_period">
			<option value="hour" <?php selected($time_period, 'hour'); ?>><?php esc_html_e('Hour', 'tryloom'); ?></option>
			<option value="day" <?php selected($time_period, 'day'); ?>><?php esc_html_e('Day', 'tryloom'); ?></option>
			<option value="week" <?php selected($time_period, 'week'); ?>><?php esc_html_e('Week', 'tryloom'); ?></option>
			<option value="month" <?php selected($time_period, 'month'); ?>><?php esc_html_e('Month', 'tryloom'); ?>
			</option>
		</select>
		<p class="description">
			<?php esc_html_e('Select the time period for the generation limit (Hour / Day / Week / Month).', 'tryloom'); ?>
		</p>
		<?php
	}

	/**
	 * Delete photos days callback.
	 */
	public function delete_photos_days_callback()
	{
		$delete_photos_days = get_option('tryloom_delete_photos_days', 30);
		?>
		<input type="number" name="tryloom_delete_photos_days" value="<?php echo esc_attr($delete_photos_days); ?>" min="1"
			step="1" />
		<p class="description">
			<?php esc_html_e("Automatically deletes user photos and generated results older than this limit.", 'tryloom'); ?>
		</p>
		<?php
	}

	/**
	 * Allowed user roles callback.
	 */
	public function allowed_user_roles_callback()
	{
		$allowed_user_roles = get_option('tryloom_allowed_user_roles', array('customer'));
		$roles = get_editable_roles();
		?>
		<select name="tryloom_allowed_user_roles[]" multiple="multiple" class="wc-enhanced-select" style="width: 400px;">
			<?php
			foreach ($roles as $role_key => $role) {
				$selected = in_array($role_key, $allowed_user_roles, true) ? 'selected="selected"' : '';
				echo '<option value="' . esc_attr($role_key) . '" ' . esc_attr($selected) . '>' . esc_html(translate_user_role($role['name'])) . '</option>';
			}
			?>
		</select>
		<p class="description"><?php esc_html_e('Select which user roles can use the Try-On feature.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Enable logging callback.
	 */
	public function enable_logging_callback()
	{
		$enable_logging = get_option('tryloom_enable_logging', 'no');
		?>
		<select name="tryloom_enable_logging">
			<option value="yes" <?php selected($enable_logging, 'yes'); ?>><?php esc_html_e('Yes', 'tryloom'); ?></option>
			<option value="no" <?php selected($enable_logging, 'no'); ?>><?php esc_html_e('No', 'tryloom'); ?></option>
		</select>
		<p class="description"><?php esc_html_e('Turn on TryLoom system logs for debugging.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Admin user roles callback.
	 */
	public function admin_user_roles_callback()
	{
		$admin_user_roles = get_option('tryloom_admin_user_roles', array('administrator', 'shop_manager'));
		$roles = get_editable_roles();
		?>
		<select name="tryloom_admin_user_roles[]" multiple="multiple" class="wc-enhanced-select" style="width: 400px;">
			<?php
			foreach ($roles as $role_key => $role) {
				$selected = in_array($role_key, $admin_user_roles, true) ? 'selected="selected"' : '';
				echo '<option value="' . esc_attr($role_key) . '" ' . esc_attr($selected) . '>' . esc_html(translate_user_role($role['name'])) . '</option>';
			}
			?>
		</select>
		<p class="description"><?php esc_html_e('Select which admin roles can access TryLoom settings.', 'tryloom'); ?></p>
		<?php
	}

	/**
	 * Show popup errors callback.
	 */
	public function show_popup_errors_callback()
	{
		$show_popup_errors = get_option('tryloom_show_popup_errors', 'no');
		?>
		<select name="tryloom_show_popup_errors">
			<option value="yes" <?php selected($show_popup_errors, 'yes'); ?>><?php esc_html_e('Yes', 'tryloom'); ?>
			</option>
			<option value="no" <?php selected($show_popup_errors, 'no'); ?>><?php esc_html_e('No', 'tryloom'); ?></option>
		</select>
		<p class="description">
			<?php esc_html_e('Show frontend popup errors for missing keys, API failures, or other issues. Recommended only for debugging.', 'tryloom'); ?>
		</p>
		<?php
	}

	/**
	 * Remove data on delete callback.
	 */
	public function remove_data_on_delete_callback()
	{
		$remove_data = get_option('tryloom_remove_data_on_delete', 'no');
		?>
		<label>
			<input type="checkbox" name="tryloom_remove_data_on_delete" value="yes" <?php checked($remove_data, 'yes'); ?> />
			<?php esc_html_e('Remove all data when I delete the plugin', 'tryloom'); ?>
		</label>
		<p class="description">
			<?php esc_html_e('If checked, all TryLoom database tables, settings, and uploaded images will be permanently deleted when you delete the plugin from the Plugins screen.', 'tryloom'); ?>
		</p>
		<?php
	}

	/**
	 * Custom popup CSS callback.
	 */
	public function custom_popup_css_callback()
	{
		$css = get_option('tryloom_custom_popup_css', '');
		?>
		<textarea name="tryloom_custom_popup_css" rows="10" class="large-text code"><?php echo esc_textarea($css); ?></textarea>
		<p class="description">
			<?php esc_html_e('Add custom CSS for the TryLoom popup modal.', 'tryloom'); ?><br>
			<strong><?php esc_html_e('CSS Classes:', 'tryloom'); ?></strong>
			<code>.tryloom-popup</code>, <code>.tryloom-popup-content</code>,
			<code>.tryloom-popup-header</code>, <code>.tryloom-popup-body</code>,
			<code>.tryloom-upload-area</code>, <code>.tryloom-variations-container</code>,
			<code>.tryloom-result</code>
		</p>
		<?php
	}

	/**
	 * Custom button CSS callback.
	 */
	public function custom_button_css_callback()
	{
		$css = get_option('tryloom_custom_button_css', '');
		?>
		<textarea name="tryloom_custom_button_css" rows="10"
			class="large-text code"><?php echo esc_textarea($css); ?></textarea>
		<p class="description">
			<?php esc_html_e('Add custom CSS for the Try-On button.', 'tryloom'); ?><br>
			<strong><?php esc_html_e('CSS Classes:', 'tryloom'); ?></strong>
			<code>.tryloom-button</code>
		</p>
		<?php
	}

	/**
	 * Custom account CSS callback.
	 */
	public function custom_account_css_callback()
	{
		$css = get_option('tryloom_custom_account_css', '');
		?>
		<textarea name="tryloom_custom_account_css" rows="10"
			class="large-text code"><?php echo esc_textarea($css); ?></textarea>
		<p class="description">
			<?php esc_html_e('Add custom CSS for the Try-On tab in the My Account page.', 'tryloom'); ?><br>
			<strong><?php esc_html_e('CSS Classes:', 'tryloom'); ?></strong>
			<code>.tryloom-account</code>, <code>.tryloom-account-photos</code>,
			<code>.tryloom-account-photo</code>, <code>.tryloom-history-table</code>
		</p>
		<?php
	}

	/**
	 * Enable history callback.
	 */
	public function enable_history_callback()
	{
		$enabled = get_option('tryloom_enable_history', 'yes');

		// Calculate stats for History
		$stats = $this->get_storage_stats('tryloom_history', 'generated_image_url');
		$has_history = $stats['count'] > 0;
		?>
		<select name="tryloom_enable_history">
			<option value="yes" <?php selected($enabled, 'yes'); ?>><?php esc_html_e('Yes', 'tryloom'); ?></option>
			<option value="no" <?php selected($enabled, 'no'); ?>><?php esc_html_e('No', 'tryloom'); ?></option>
		</select>
		<p class="description">
			<?php esc_html_e('Enable or disable Try-On history tracking.', 'tryloom'); ?><br>
			<?php esc_html_e('When off: No history shown, and generated images auto-delete after 5 minutes.', 'tryloom'); ?><br>
			<strong><?php esc_html_e('Note: Turning this off will also hide the Try-On tab in My Account.', 'tryloom'); ?></strong>
		</p>
		<div style="margin-top: 15px;">
			<button type="button" id="tryloom_clear_history_btn" class="button button-secondary" <?php echo !$has_history ? 'disabled' : ''; ?>>
				<i class="fas fa-trash"></i>
				<?php esc_html_e('Clear All History', 'tryloom'); ?>
			</button>
			<span style="margin-left: 10px; font-style: italic; color: #666;">
				<?php
				/* translators: 1: Number of images, 2: Total size of images */
				printf(esc_html__('(Saved: %1$d images | Size: %2$s)', 'tryloom'), esc_html($stats['count']), esc_html($this->format_size($stats['size'])));
				?>
			</span>
			<script type="text/javascript">
				jQuery(document).ready(function ($) {
					$('#tryloom_clear_history_btn').on('click', function (e) {
						e.preventDefault();
						if ($(this).attr('disabled')) return;
						if (confirm('<?php echo esc_js(__('Are you sure you want to clear all try-on history? This will permanently delete all generated images from the server.', 'tryloom')); ?>')) {
							// Create a form outside of the existing one to avoid nesting issues
							var form = $('<form action="<?php echo esc_url(admin_url('admin-post.php')); ?>" method="post">' +
								'<input type="hidden" name="action" value="tryloom_clear_all_history" />' +
								'<input type="hidden" name="_wpnonce" value="<?php echo esc_attr(wp_create_nonce('tryloom_clear_all_history')); ?>" />' +
								'</form>');
							$('body').append(form);
							form.submit();
						}
					});
				});
			</script>
		</div>
		<?php
	}



	/**
	 * Add settings link on plugin page.
	 *
	 * @param array $links Plugin action links.
	 * @return array
	 */
	public function add_settings_link($links)
	{
		$settings_link = '<a href="admin.php?page=tryloom-settings">' . __('Settings', 'tryloom') . '</a>';
		array_unshift($links, $settings_link);
		return $links;
	}

	/**
	 * Get file path from URL using WordPress upload directory.
	 *
	 * @param string $image_url The URL of the image.
	 * @return string|false File path on success, false on failure.
	 */
	private function get_file_path_from_url($image_url)
	{
		if (empty($image_url)) {
			return false;
		}

		// If the URL is a protected URL, extract the filename and get path from custom directory
		if (strpos($image_url, '?tryloom_image=') !== false) {
			$parsed_url = wp_parse_url($image_url);
			if (isset($parsed_url['query'])) {
				parse_str($parsed_url['query'], $query_params);
				if (isset($query_params['tryloom_image'])) {
					$image_name = sanitize_file_name($query_params['tryloom_image']);
					$upload_dir = wp_upload_dir();
					$protected_image_path = $upload_dir['basedir'] . '/tryloom/' . $image_name;
					if (file_exists($protected_image_path)) {
						return $protected_image_path;
					}
				}
			}
		}

		// Try to get attachment ID and file path
		$attachment_id = attachment_url_to_postid($image_url);
		if ($attachment_id) {
			$file_path = get_attached_file($attachment_id);
			if ($file_path && file_exists($file_path)) {
				return $file_path;
			}
		}

		// Try to extract path from uploads directory URL
		$upload_dir = wp_upload_dir();
		$upload_base_url = $upload_dir['baseurl'];
		$upload_base_dir = $upload_dir['basedir'];

		// Check if URL is within uploads directory
		if (strpos($image_url, $upload_base_url) === 0) {
			$relative_path = str_replace($upload_base_url, '', $image_url);
			// Remove query string if present
			$relative_path = strtok($relative_path, '?');
			$file_path = $upload_base_dir . $relative_path;
			if (file_exists($file_path)) {
				return $file_path;
			}
		}

		return false;
	}

	/**
	 * Clear all try-on history.
	 */
	public function clear_all_history()
	{
		// Check nonce and permissions.
		if (!isset($_POST['_wpnonce']) || !wp_verify_nonce(sanitize_text_field(wp_unslash($_POST['_wpnonce'])), 'tryloom_clear_all_history') || !current_user_can('manage_woocommerce')) {
			wp_die(esc_html__('You do not have sufficient permissions to access this page.', 'tryloom'));
		}

		if (function_exists('set_time_limit')) {
			set_time_limit(300);
		}

		global $wpdb;
		$table_name = $wpdb->prefix . 'tryloom_history';

		// Get all history records to delete associated files.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
		$history_records = $wpdb->get_results('SELECT generated_image_url FROM ' . esc_sql($table_name) . " WHERE generated_image_url IS NOT NULL AND generated_image_url != ''");

		// Delete associated files.
		foreach ($history_records as $record) {
			if (!empty($record->generated_image_url)) {
				$file_path = $this->get_file_path_from_url($record->generated_image_url);
				if ($file_path && file_exists($file_path)) {
					wp_delete_file($file_path);
				}

				// Delete from media library.
				$attachment_id = attachment_url_to_postid($record->generated_image_url);
				if ($attachment_id) {
					wp_delete_attachment($attachment_id, true);
				}
			}
		}

		// Clear all history records.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
		$wpdb->query('DELETE FROM ' . esc_sql($table_name));

		// Redirect back with success message.
		wp_safe_redirect(add_query_arg(array('page' => 'tryloom-settings', 'history_cleared' => '1'), admin_url('admin.php')));
		exit;
	}

	/**
	 * Delete all saved user photos.
	 */
	public function delete_user_photos()
	{
		// Check nonce and permissions.
		if (!isset($_POST['_wpnonce']) || !wp_verify_nonce(sanitize_text_field(wp_unslash($_POST['_wpnonce'])), 'tryloom_delete_user_photos') || !current_user_can('manage_woocommerce')) {
			wp_die(esc_html__('You do not have sufficient permissions to access this page.', 'tryloom'));
		}

		if (function_exists('set_time_limit')) {
			set_time_limit(300);
		}

		global $wpdb;
		$table_name = $wpdb->prefix . 'tryloom_user_photos';

		// Get all photo records to delete associated files.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Custom table, not public data
		$photo_records = $wpdb->get_results('SELECT image_url, attachment_id FROM ' . esc_sql($table_name));

		// Delete associated files.
		foreach ($photo_records as $record) {

			// Delete from media library if attached
			if (!empty($record->attachment_id)) {
				wp_delete_attachment($record->attachment_id, true);
			}

			// Delete file from custom path if exists (and not already deleted by attachment delete)
			if (!empty($record->image_url)) {
				$file_path = $this->get_file_path_from_url($record->image_url);
				if ($file_path && file_exists($file_path)) {
					wp_delete_file($file_path);
				}
			}
		}

		// Delete from DB.
		// phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching,WordPress.DB.PreparedSQL.NotPrepared -- Custom table cleanup
		$wpdb->query("DELETE FROM " . esc_sql($table_name));

		// Redirect back with success message.
		wp_safe_redirect(add_query_arg(array('page' => 'tryloom-settings', 'message' => 'photos_deleted'), admin_url('admin.php')));
		exit;
	}

	/**
	 * Helper: Get storage stats (count and size) for a table's image column.
	 * 
	 * @param string $table_name Table name (without prefix).
	 * @param string $url_column Column name containing the image URL.
	 * @return array ['count' => int, 'size' => int]
	 */
	private function get_storage_stats($table_name_suffix, $url_column)
	{
		global $wpdb;
		$table_name = $wpdb->prefix . $table_name_suffix;

		// Check table exists first to avoid errors during install/updates
		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- System table check
		if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $table_name)) != $table_name) {
			return array('count' => 0, 'size' => 0);
		}

		$safe_column = esc_sql($url_column);
		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Column name validated through esc_sql sanitization
		$urls = $wpdb->get_col("SELECT `$safe_column` FROM " . esc_sql($table_name) . " WHERE `$safe_column` IS NOT NULL AND `$safe_column` != ''");

		$count = 0;
		$size = 0;

		foreach ($urls as $url) {
			$path = $this->get_file_path_from_url($url);
			if ($path && file_exists($path)) {
				$count++;
				$size += filesize($path);
			}
		}

		return array('count' => count($urls), 'found_files_count' => $count, 'size' => $size);
	}

	/**
	 * Helper: Format bytes to human readable string.
	 * 
	 * @param int $bytes
	 * @param int $precision
	 * @return string
	 */
	private function format_size($bytes, $precision = 2)
	{
		$units = array('B', 'KB', 'MB', 'GB', 'TB');
		$bytes = max($bytes, 0);
		$pow = floor(($bytes ? log($bytes) : 0) / log(1024));
		$pow = min($pow, count($units) - 1);
		$bytes /= pow(1024, $pow);
		return round($bytes, $precision) . ' ' . $units[$pow];
	}

	/**
	 * Display admin notices.
	 */
	public function admin_notices()
	{
		// phpcs:ignore WordPress.Security.NonceVerification.Recommended
		if (isset($_GET['history_cleared']) && '1' === sanitize_text_field(wp_unslash($_GET['history_cleared']))) {
			echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('All try-on history has been cleared successfully.', 'tryloom') . '</p></div>';
		}

		// Show subscription ended notice on all admin pages
		$subscription_ended = get_option('tryloom_subscription_ended', 'no');
		if ('yes' === $subscription_ended) {
			echo '<div class="notice notice-error is-dismissible"><p>' .
				// phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- HTML allowed
				__('Your TryLoom subscription has expired or payment failed.<br><strong>Your customers cannot see the Virtual Try-On button.</strong><br><a href="https://tryloom.toolteek.com/my-account/">Click here to renew now</a> to restore service immediately.', 'tryloom') .
				'</p></div>';
		}

		// Warning if Cron is not working
		if (!wp_next_scheduled('tryloom_check_account_status') || !wp_next_scheduled('tryloom_cleanup_inactive_users')) {
			echo '<div class="notice notice-warning is-dismissible"><p><strong>' . esc_html__('TryLoom System Warning:', 'tryloom') . '</strong> ' . esc_html__('Scheduled tasks (WP-Cron) do not appear to be running. This may prevent automatic history cleanup and account status checks.', 'tryloom') . '</p></div>';
		}

		// Only show conflict warnings on Try On settings page.
		$screen = get_current_screen();
		if (!$screen || ('toplevel_page_tryloom-settings' !== $screen->id && 'woocommerce_page_tryloom-settings' !== $screen->id)) {
			return;
		}

		// Check for potential conflicts.
		$conflicts = array();

		// Check for JavaScript conflicts.
		if (wp_script_is('jquery-ui-dialog') || wp_script_is('fancybox')) {
			$conflicts[] = __('Popup/Modal library detected that may conflict with Try On popup functionality.', 'tryloom');
		}

		// Check for CSS conflicts - look for common optimization plugins.
		$active_plugins = get_option('active_plugins');
		if (is_array($active_plugins)) {
			foreach ($active_plugins as $plugin) {
				if (
					strpos($plugin, 'autoptimize') !== false ||
					strpos($plugin, 'wp-rocket') !== false ||
					strpos($plugin, 'w3-total-cache') !== false
				) {
					$conflicts[] = __('CSS/JS optimization plugin detected. If Try On features don\'t work properly, try clearing cache or excluding Try On files from optimization.', 'tryloom');
					break;
				}
			}
		}

		// Check for theme conflicts by looking for custom CSS that might override.
		global $wpdb;
		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching
		$custom_css = $wpdb->get_var("SELECT post_content FROM {$wpdb->posts} WHERE post_type = 'custom_css' AND post_status = 'publish' LIMIT 1");
		if ($custom_css && (strpos($custom_css, '.tryloom') !== false || strpos($custom_css, 'try-on') !== false)) {
			$conflicts[] = __('Custom CSS targeting Try On elements detected in theme customizer. This may affect plugin styling.', 'tryloom');
		}

		// Check for AJAX conflicts.
		global $wp_filter;
		if (isset($wp_filter['wp_ajax_tryloom_generate']) && is_array($wp_filter['wp_ajax_tryloom_generate']) && count($wp_filter['wp_ajax_tryloom_generate']) > 1) {
			$conflicts[] = __('Another plugin is hooking into Try On AJAX actions. This may cause functionality issues.', 'tryloom');
		}

		// Display warnings if conflicts detected.
		if (!empty($conflicts)) {
			echo '<div class="notice notice-warning is-dismissible">';
			echo '<p><strong>' . esc_html__('WooCommerce Try On - Potential Conflicts Detected:', 'tryloom') . '</strong></p>';
			echo '<ul style="list-style: disc; padding-left: 20px;">';
			foreach ($conflicts as $conflict) {
				echo '<li>' . esc_html($conflict) . '</li>';
			}
			echo '</ul>';
			echo '<p>' . esc_html__('If you experience issues, try deactivating other plugins one by one to identify the conflict, or contact support.', 'tryloom') . '</p>';
			echo '</div>';
		}
	}


	/**
	 * Enqueue admin scripts and styles.
	 */
	public function enqueue_admin_scripts($hook)
	{
		// if ('toplevel_page_tryloom-settings' !== $hook && 'woocommerce_page_tryloom-settings' !== $hook) {
		// 	return;
		// }

		// Enqueue Font Awesome.
		// Note: Font Awesome is bundled locally for WordPress.org compliance.
		// Enqueue Font Awesome.
		// Note: Using CDN as local bundle check failed
		wp_enqueue_style(
			'font-awesome',
			'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
			array(),
			'6.4.0'
		);

		// Enqueue WooCommerce Admin Styles (for SelectWoo/Select2).
		wp_enqueue_style('woocommerce_admin_styles');

		// Enqueue color picker.
		wp_enqueue_style('wp-color-picker');
		wp_enqueue_script('wp-color-picker');

		// Enqueue media uploader.
		wp_enqueue_media();

		// Enqueue admin script.
		wp_enqueue_script(
			'tryloom-admin',
			TRYLOOM_PLUGIN_URL . 'assets/js/admin.js',
			array('jquery', 'wp-color-picker', 'selectWoo'),
			time(), // Force reload
			true
		);

		// Enqueue admin style.
		wp_enqueue_style(
			'tryloom-admin',
			TRYLOOM_PLUGIN_URL . 'assets/css/admin.css',
			array(),
			TRYLOOM_VERSION
		);
	}

	/**
	 * Add dashboard widget for statistics.
	 */
	public function add_dashboard_widget()
	{
		if (!current_user_can('manage_woocommerce')) {
			return;
		}

		wp_add_dashboard_widget(
			'tryloom_stats_widget',
			__('Try On Statistics', 'tryloom'),
			array($this, 'dashboard_widget_callback')
		);
	}

	/**
	 * Dashboard widget callback.
	 */
	public function dashboard_widget_callback()
	{
		global $wpdb;

		$stats = get_transient('tryloom_stats');
		if (false === $stats) {
			// Get total try-ons in the last hour.
			$table_name = $wpdb->prefix . 'tryloom_history';
			$hour_ago = gmdate('Y-m-d H:i:s', strtotime('-1 hour'));
			// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
			$total_hour = $wpdb->get_var($wpdb->prepare('SELECT COUNT(*) FROM ' . esc_sql($table_name) . ' WHERE created_at > %s', $hour_ago));

			// Get total try-ons in the last day.
			$day_ago = gmdate('Y-m-d H:i:s', strtotime('-1 day'));
			// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
			$total_day = $wpdb->get_var($wpdb->prepare('SELECT COUNT(*) FROM ' . esc_sql($table_name) . ' WHERE created_at > %s', $day_ago));

			// Get total try-ons in the last week.
			$week_ago = gmdate('Y-m-d H:i:s', strtotime('-1 week'));
			// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
			$total_week = $wpdb->get_var($wpdb->prepare('SELECT COUNT(*) FROM ' . esc_sql($table_name) . ' WHERE created_at > %s', $week_ago));

			// Get total try-ons all time.
			// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
			$total_all = $wpdb->get_var('SELECT COUNT(*) FROM ' . esc_sql($table_name));

			// Get top products.
			// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
			$top_products = $wpdb->get_results(
				'SELECT product_id, COUNT(*) as count FROM ' . esc_sql($table_name) . ' GROUP BY product_id ORDER BY count DESC LIMIT 5'
			);

			$stats = array(
				'total_hour' => $total_hour,
				'total_day' => $total_day,
				'total_week' => $total_week,
				'total_all' => $total_all,
				'top_products' => $top_products
			);

			set_transient('tryloom_stats', $stats, 3600);
		} else {
			$total_hour = $stats['total_hour'];
			$total_day = $stats['total_day'];
			$total_week = $stats['total_week'];
			$total_all = $stats['total_all'];
			$top_products = $stats['top_products'];
		}

		// Display statistics.
		?>
		<div class="tryloom-stats">
			<div class="tryloom-stats-item">
				<h4><?php esc_html_e('Try-Ons in the Last Hour', 'tryloom'); ?></h4>
				<p class="tryloom-stats-number"><?php echo esc_html($total_hour); ?></p>
			</div>
			<div class="tryloom-stats-item">
				<h4><?php esc_html_e('Try-Ons in the Last Day', 'tryloom'); ?></h4>
				<p class="tryloom-stats-number"><?php echo esc_html($total_day); ?></p>
			</div>
			<div class="tryloom-stats-item">
				<h4><?php esc_html_e('Try-Ons in the Last Week', 'tryloom'); ?></h4>
				<p class="tryloom-stats-number"><?php echo esc_html($total_week); ?></p>
			</div>
			<div class="tryloom-stats-item">
				<h4><?php esc_html_e('Total Try-Ons', 'tryloom'); ?></h4>
				<p class="tryloom-stats-number"><?php echo esc_html($total_all); ?></p>
			</div>
		</div>

		<h4><?php esc_html_e('Top Products', 'tryloom'); ?></h4>
		<ul class="tryloom-top-products">
			<?php
			if (!empty($top_products)) {
				foreach ($top_products as $product) {
					$product_title = get_the_title($product->product_id);
					echo '<li><a href="' . esc_url(get_edit_post_link($product->product_id)) . '">' . esc_html($product_title) . '</a> (' . esc_html($product->count) . ')</li>';
				}
			} else {
				echo '<li>' . esc_html__('No data available yet.', 'tryloom') . '</li>';
			}
			?>
		</ul>

		<p>
			<a href="<?php echo esc_url(admin_url('admin.php?page=tryloom-settings')); ?>" class="button">
				<?php esc_html_e('Try On Settings', 'tryloom'); ?>
			</a>
		</p>
		<?php
	}

	/**
	 * Handler for starting free trial (admin_post action).
	 */
	/* start_free_trial method removed */

	/**
	 * Settings page.
	 */
	public function settings_page()
	{
		// Force check status if subscription ended (user visiting settings page)
		if ('yes' === get_option('tryloom_subscription_ended', 'no')) {
			if (function_exists('tryloom') && tryloom()->api) {
				tryloom()->api->check_usage_status();
			}
		}

		// Get statistics.
		global $wpdb;
		$today = gmdate('Y-m-d');
		$thirty_days_ago = gmdate('Y-m-d', strtotime('-30 days'));
		$midnight = strtotime('today');
		$history_table = $wpdb->prefix . 'tryloom_history';

		// Today's Active Users - Count distinct users who used try-on today.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
		$today_active_users = $wpdb->get_var(
			$wpdb->prepare(
				'SELECT COUNT(DISTINCT user_id) FROM ' . esc_sql($history_table) . ' WHERE created_at >= %s AND created_at <= %s',
				$today . ' 00:00:00',
				$today . ' 23:59:59'
			)
		);

		// Today's Try-On Used Times - Total generations today.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
		$today_try_on_count = $wpdb->get_var(
			$wpdb->prepare(
				'SELECT COUNT(*) FROM ' . esc_sql($history_table) . ' WHERE created_at >= %s AND created_at <= %s',
				$today . ' 00:00:00',
				$today . ' 23:59:59'
			)
		);

		// Last 30 Days Active Users.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
		$last_30_days_users = $wpdb->get_var(
			$wpdb->prepare(
				'SELECT COUNT(DISTINCT user_id) FROM ' . esc_sql($history_table) . ' WHERE created_at >= %s',
				$thirty_days_ago . ' 00:00:00'
			)
		);

		// Last 30 Days Try-On Used Times.
		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared,WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching -- Table name sanitized with esc_sql()
		$last_30_days_count = $wpdb->get_var(
			$wpdb->prepare(
				'SELECT COUNT(*) FROM ' . esc_sql($history_table) . ' WHERE created_at >= %s',
				$thirty_days_ago . ' 00:00:00'
			)
		);
		?>
		<div class="wrap tryloom-settings">
			<h1><?php esc_html_e('TryLoom Settings  - Virtual Try On for WooCommerce', 'tryloom'); ?></h1>

			<!-- Statistics Grid -->
			<div class="tryloom-daily-stats">
				<div class="tryloom-stat-box">
					<h3><?php esc_html_e("Today's Active Users", 'tryloom'); ?></h3>
					<p class="stat-number"><?php echo esc_html($today_active_users); ?></p>
				</div>
				<div class="tryloom-stat-box">
					<h3><?php esc_html_e("Today's Try-On Uses", 'tryloom'); ?></h3>
					<p class="stat-number"><?php echo esc_html($today_try_on_count); ?></p>
				</div>
			</div>

			<div class="tryloom-daily-stats" style="margin-top: 10px;">
				<div class="tryloom-stat-box">
					<h3><?php esc_html_e('Last 30 Days Active Users', 'tryloom'); ?></h3>
					<p class="stat-number"><?php echo esc_html($last_30_days_users); ?></p>
				</div>
				<div class="tryloom-stat-box">
					<h3><?php esc_html_e('Last 30 Days Try-On Uses', 'tryloom'); ?></h3>
					<p class="stat-number"><?php echo esc_html($last_30_days_count); ?></p>
				</div>
			</div>

			<?php
			// Display usage counter if available
			$usage_used = get_option('tryloom_usage_used', null);
			$usage_limit = get_option('tryloom_usage_limit', null);
			if (null !== $usage_used && null !== $usage_limit) {
				?>
				<div class="tryloom-daily-stats" style="margin-top: 10px;">
					<div class="tryloom-stat-box">
						<h3><?php esc_html_e('Usage Counter', 'tryloom'); ?></h3>
						<p class="stat-number"><?php echo esc_html($usage_used); ?> / <?php echo esc_html($usage_limit); ?></p>
						<p class="description">
							<?php esc_html_e('Your current Try-On usage compared to your monthly (or plan-based) limit.', 'tryloom'); ?>
						</p>
					</div>
				</div>
				<?php
			}
			?>

			<?php
			// Check if free or paid key exists
			$paid_key = get_option('tryloom_platform_key', '');
			$free_key = get_option('tryloom_free_platform_key', '');
			$show_start_free_button = empty($paid_key) && empty($free_key);
			// Removed nonce generation for start free trial
			?>
			<div class="tryloom-header">
				<div class="tryloom-header-info">
					<p><?php esc_html_e('Explore Subscription Plans for TryLoom', 'tryloom'); ?></p>
				</div>
				<div class="tryloom-header-actions">
					<?php if ($show_start_free_button): ?>
						<a href="https://tryloom.toolteek.com/my-account/" class="button button-primary" target="_blank"
							style="margin-right: 10px;">
							<?php esc_html_e('Start for Free', 'tryloom'); ?>
						</a>
					<?php endif; ?>
					<a href="https://tryloom.toolteek.com/#pricing" class="button button-primary" target="_blank">
						<?php esc_html_e('Subscription Options', 'tryloom'); ?>
					</a>
				</div>
			</div>

			<form method="post" action="options.php" class="tryloom-settings-form">
				<?php
				settings_fields('tryloom-settings-group');
				do_settings_sections('tryloom-settings');
				submit_button();
				?>
			</form>

			<div class="tryloom-footer">
				<h3><?php esc_html_e('Privacy Policy', 'tryloom'); ?></h3>
				<p><?php esc_html_e('Please add appropriate privacy statements to your Privacy Policy page.', 'tryloom'); ?>
				</p>
				<p><?php esc_html_e('Suggested privacy policy text:', 'tryloom'); ?></p>
				<blockquote
					style="background: #f4f4f4; padding: 12px 16px; border-left: 4px solid #552FBC; border-radius: 4px;">
					<p>
						<?php esc_html_e('When you use our virtual try-on feature, we may collect and process images you upload for the purpose of showing how products may look when worn. These images may be stored on our server based on your preferences and our settings. You can manage your saved images in your account settings.', 'tryloom'); ?>
					</p>
				</blockquote>
			</div>
		</div>
		<?php
	}
}